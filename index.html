<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <title>GCP ping</title>
<style>
body, input {
  font-family: 'Arial', sans-serif;
}

h1, h3 {
  text-align: center;
}

thead {
	font-weight: bold;
}

#container {
  width: 600px;
  margin: auto;
}

a, a:visited {
  color: blue;
}

td {
  padding: 10px;
  text-align: center;
  width: 33%;
}

td.result {
  width: 100px;
  text-align: right;
  font-family: monospace;
}

table, td {
  border: 1px solid black;
}

table {
  width: 100%;
}

tr#lastrow td {
  border: 0;
}

button {
  height: 50px;
  width: 100px;
  display: block;
  margin: auto;
  margin-top: 10px;
  color: white;
}
</style>
</head>
<body>
  <div id="container">
  <h1>Measure your latency to <a href="https://cloud.google.com/compute/docs/regions-zones/regions-zones">GCP regions</a></h1>
  <table>
		<thead><tr>
      <td>Region</td>
      <td>Google Compute Engine</td>
      <td>Google Cloud Storage</td>
    </tr></thead>
    <tr>
      <td><a href="https://www.google.com/about/datacenters/inside/locations/council-bluffs/">us-central1</a></td>
      <td class="result" id="gce-us-central1-result">&nbsp;</td>
      <td class="result" id="gcs-us-central1-result">&nbsp;</td>
    </tr>
    <tr>
      <td><a href="https://www.google.com/about/datacenters/inside/locations/berkeley-county/">us-east1</a></td>
      <td class="result" id="gce-us-east1-result">&nbsp;</td>
      <td class="result" id="gcs-us-east1-result">&nbsp;</td>
    </tr>
    <tr>
      <td><a href="https://www.google.com/about/datacenters/inside/locations/the-dalles/">us-west1</a></td>
      <td class="result" id="gce-us-west1-result">&nbsp;</td>
      <td class="result" id="gcs-us-west1-result">&nbsp;</td>
    </tr>
    <tr>
      <td><a href="https://www.google.com/about/datacenters/inside/locations/st-ghislain/">europe-west1</a></td>
      <td class="result" id="gce-europe-west1-result">&nbsp;</td>
      <td class="result" id="gcs-europe-west1-result">&nbsp;</td>
    </tr>
    <tr>
      <td><a href="https://www.google.com/about/datacenters/inside/locations/changhua-county/">asia-east1</a></td>
      <td class="result" id="gce-asia-east1-result">&nbsp;</td>
      <td class="result" id="gcs-asia-east1-result">&nbsp;</td>
    </tr>
    <tr>
      <td>asia-northeast1</td>
      <td class="result" id="gce-asia-northeast1-result">&nbsp;</td>
      <td class="result" id="gcs-asia-northeast1-result">&nbsp;</td>
    </tr>
  </table>
  
  <button id="stopstart">Stop</button>
  
  <h3>How does this work?</h3>
  <p>For Compute Engine, requests are made to a <code>f1-micro</code> instance in each region. For Cloud Storage, a small object is fetched from a bucket in each region. The average time between request and response are shown.</p>
	
	<p><a href="https://github.com/imjasonh/gcping">Source available on GitHub</a></p>
  </div>
</body>
<script type="text/javascript">
// TODO: Highlight fastest/closest region.
// TODO: Show regions on a map, with lines overlayed according to ping times.
// TODO: Add an option to contribute times and JS geolocation info to a public BigQuery dataset.
// TODO: Add pings for GAE, GCF, GCR(?), etc.

const _URLS = {
  'gce-us-central1':     'http://104.197.165.8/ping',
  'gce-us-east1':        'http://104.196.161.21/ping',
  'gce-us-west1':        'http://104.199.116.74/ping',
  'gce-europe-west1':    'http://104.199.82.109/ping',
  'gce-asia-east1':      'http://104.155.201.52/ping',
  'gce-asia-northeast1': 'http://104.198.86.148/ping',
  'gcs-us-central1':     'https://storage.googleapis.com/gcping-us-central1/ping',
  'gcs-us-east1':        'https://storage.googleapis.com/gcping-us-east1/ping',
  'gcs-us-west1':        'https://storage.googleapis.com/gcping-us-west1/ping',
  'gcs-europe-west1':    'https://storage.googleapis.com/gcping-europe-west1/ping',
  'gcs-asia-east1':      'https://storage.googleapis.com/gcping-asia-east1/ping',
  'gcs-asia-northeast1': 'https://storage.googleapis.com/gcping-asia-northeast1/ping',
};
let _KEYS = [];
let idx = 0;
let _URLS_REVERSE = {}; // reverse of _URLS
let results = {};
for (k in _URLS) {
  _KEYS.push(k);
  _URLS_REVERSE[_URLS[k]] = k;
  results[k] = [];
}
const _TIMEOUT = 3000; // ms

function ping(url, cb) {
  let start = new Date().getTime();
  let xhr = new XMLHttpRequest();
  xhr.open('GET', url);
  xhr.timeout = _TIMEOUT;
  xhr.onreadystatechange = function() {
    let took = new Date().getTime()-start;
    if (xhr.readyState != 4) { return; }
    if (xhr.status >= 400) {
      console.error(xhr);
      cb({'error': true});
    } else if (took > xhr.timeout) {
      cb({'timeout':true});
    } else {
      k = _URLS_REVERSE[url];
      results[k].push(took);
      cb({});
    }
  };
  try {
    xhr.send('');
  } catch (e) {
    console.error(e);
    cb({'error': true});
    return;
  }
}

function avg(arr) {
  let sum = 0;
  arr.forEach(function(x) { sum += x });
  return sum / arr.length;
}

document.addEventListener('nextping', function() {
  let id = _KEYS[idx];
  idx = (idx+1)%_KEYS.length; // wrap around
  ping(_URLS[id], function(res) {
    let a = avg(results[id]);
    let out = document.getElementById(id+'-result');
    if (res['error'] != undefined) {
      out.style.backgroundColor = 'red';
      out.style.color = 'white';
      out.innerText = 'error';
    } else if (res['timeout'] != undefined) {
      out.style.backgroundColor = 'gray';
      out.style.color = 'white';
      out.innerText = '>' + _TIMEOUT.toFixed(2) + 'ms';
    } else {
      out.style.backgroundColor = 'white';
      out.style.color = 'black';
      out.innerText = a.toFixed(2) + 'ms';
    }
    if (!stopped) {
      setTimeout(function() {
        document.dispatchEvent(new Event('nextping'));
      }, 100);
    }
  });
});

let stopped = true;
let stopstart = document.getElementById('stopstart')
stopstart.onclick = function() {
  if (stopped) {
    console.log('starting');
    stopped = false;
    stopstart.innerText = 'Stop';
    stopstart.style.backgroundColor = 'red';
    document.dispatchEvent(new Event('nextping'));
    setTimeout(stopstart.onclick, 10000); // stop after 10s.
  } else {
    console.log('stopping');
    stopped = true;
    stopstart.style.backgroundColor = 'green';
    stopstart.innerText = 'Start';
  }
};
stopstart.onclick();
</script>
</html>
